# https://moonrepo.dev/docs/config/tasks
$schema: 'https://moonrepo.dev/schemas/tasks.json'

fileGroups:
  configs:
    - '*.{js,json}'
  sources:
    - 'src/**/*'
  tests:
    - 'tests/**/*.test.*'

tasks:
  build:
    command: echo "Build Complete âœ“"
    deps:
      - ~:clean.dist
      - ~:compile
    inputs:
      - src
      - package.json
    options:
      cache: false
      outputStyle: 'stream'
      runDepsInParallel: false
    outputs:
      - dist

  clean.dist:
    # Note: Use rimraf so PowerShell matches Linux delete behavior
    command: rimraf dist
    inputs:
      - src
      - package.json

  compile:
    command: tshy
    inputs:
      - src
      - package.json
    options:
      runDepsInParallel: false
    outputs:
      - dist

  release:
    command: |
      versioner --target $projectRoot --publish=false
      cd $projectRoot
      PACK_DIR="$(mktemp -d -t jsx-email-pack-XXXXXX)"
      pnpm pack --pack-destination "$PACK_DIR"
      npm publish --provenance $PACK_DIR/*.tgz
      rm -rf "$PACK_DIR"
    deps:
      - ~:build
    options:
      cache: false
      outputStyle: 'stream'
      runDepsInParallel: false
