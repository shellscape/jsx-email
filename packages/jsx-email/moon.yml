# https://moonrepo.dev/docs/config/tasks
$schema: 'https://moonrepo.dev/schemas/tasks.json'

workspace:
  inheritedTasks:
    exclude: ['build', 'compile', 'release']

tasks:
  build:
    command: echo "Build Complete âœ“"
    deps:
      - ~:clean.dist
      - ~:compile
      - ~:copy.package
      - ~:copy.readme
      - ~:copy.templates
    inputs:
      - src
      - package.json
    options:
      cache: false
      outputStyle: 'stream'
      runDepsInParallel: false

  clean.readme:
    command: rm README.md
    options:
      cache: false

  compile:
    # command: tsup --config tsup.config.ts
    command: tshy
    inputs:
      - src
      - package.json
    options:
      runDepsInParallel: false

  # Note: https://github.com/isaacs/tshy/issues/61
  # For all the things that tshy solves, it creates new problems
  copy.package:
    command: cp -r ./package.json dist
    options:
      cache: false

  copy.templates:
    command: cp -r ../../assets/templates dist
    options:
      cache: false

  copy.readme:
    command: cp -r ../../README.md README.md
    options:
      cache: false

  release:
    command: rm README.md
    deps:
      - ~:release.actual
    options:
      cache: false
      outputStyle: 'stream'
      runDepsInParallel: false

  release.actual:
    command: versioner --target $projectRoot
    deps:
      - ~:build
    options:
      cache: false
      outputStyle: 'stream'
      runDepsInParallel: false

  start.preview:
    command: ts-node --swc --project ../../tsconfig.json scripts/test.ts
    options:
      cache: false

  test:
    command: vitest --config ../../shared/vitest.config.ts
    # command: vitest test/config/define-config.test.ts --config ../../shared/vitest.config.ts
    # command: vitest test/config/load/mjs/load-mjs.test.ts --config ../../shared/vitest.config.ts
    # command: vitest test/config/load/mjs-json/load-mjs-json.test.ts --config ../../shared/vitest.config.ts
    deps:
      - ~:build
    inputs:
      - src
      - test
      - package.json
    options:
      cache: false
      outputStyle: 'stream'

  tsc:
    command: tsc --project tsconfig.json
    inputs:
      - app
      - src
